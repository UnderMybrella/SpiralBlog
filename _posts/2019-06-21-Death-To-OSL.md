---
layout: post
title: "Death to OpenSpiralLanguage; How I destroyed the sanctity of Spiral"
date: 2019-06-21 15:22:00 +1000
comments: false
---

Unlike Bethesda developers, I pride myself on using code that *wasn't* written around the time I was born. 

You know what that means -

<!-- more -->

![OSL... 2!](https://media1.giphy.com/media/8eaZtOiVHKsko/giphy.gif)

^> [Peggle 2](https://www.youtube.com/watch?v=Sr57Je1fVvM) | *Also known as probably the most expensive part of Spiral now, actually[^peggle-2]*

So, let's get some things out of the way first. 
- Yes, OSL *technically* works as-is.
- No, I didn't *need* to rewrite it (yet, at least)
- Yes, there may be incompatibilities.
- No, I don't care[^kokichi].

Alright, everyone on the same page? Perfect.

## Everything is Different
^> *A stranger in my own home*

OSL "2" is similar, yet different. This is true even at a technical level; the entire system responsible for parsing OSL scripts has been overturned. Exciting!

...sort of.

Here's the thing - as it turns out, scripting is *complicated*, and parsing it is even more complicated. 

The lin (and later on, wrd) formats are too obtuse for most users to be able to work through regularly - hell, even us 'veterans' of the formats have to go back to the docs sometimes. They're not intuitive, they're complicated and unwieldy, and they're not portable!

DR1 and 2 have such vast differences[^dr2-broke-me] in structure and op codes, that you'd be writing two scripts *per script*. It'd be insane.

And let's not even get into trying to write scripts that carry over between DR1 and DRv3. It's just not feasible.

Yeah, some recoding is going to be necessary to get a fluent experience with multiple games, but considering how many similarities there are between the games that are just *slightly* different, OSL can actually enable us to write cross-game scripts. 

Both DR1 and 2 have an op code for Text, Wait Frame, and Wait for Input, so you should be able to just use the op code name and have it work.

---

Well, that's a user's perspective at least, and that's a **good mindset** to keep in mind when developing.

OSL Scripts need to model scripts for the four games, and associated minigames - *ideally*, minigame scripts should be able to be fluently integrated into regular trial scripts.

Take nonstop debates for instance. They need *three* different files to be created (e01_102_000.lin, e01_102_001.lin, nonstop_01_001.dat) and maintain a consistent state over them which is...

{% include xkcd.html comic=1349 comment="*You'd think this would be easier, and then I would tell you you're wrong. That's just the natural order.*" %}

...yeah, it's not great.

So, let's start from scratch. Right back to the beginning.

Let's start with a classic switch - changing the core engine!

## Very Deer to Me

The system that I was using originally to parse OSL scripts was called [parboiled](https://github.com/sirthias/parboiled), which has two issues.

The first, is that I've run into situations a few times where it's... not quite powerful enough to do what I need.

The second, is that the software is no longer being maintained, and future Java versions might kill it off. Uho.

So, what's the solution here? Write my own?

Well, not yet.

Enter: [ANTLR](http://antlr.org/). ANTLR was the other option back when I started work on OSL for the first time, but I sided with parboiled at first because it looked easier to natively support. Which it was.

ANTLR has a lot of support behind it, considering it's reportedly used for some pretty big projects like [parsing queries over on Twitter](https://www.antlr.org/testimonials.html), ANTLR looks to be the right tool for the job.

This also means that other tools could import the OSL grammar since ANTLR targets a few other languages, not just Java. That's right, OSL is coming to a browser near you.

Part of the switch, however, has required narrowing down the grammar for OSL quite considerably.

One of the big issues with the old version of OSL is that "feature creep"[^define-feature-creep] quickly - if you'll pardon the pun - *spiral'ed* out of control, which meant that new functionality had to be crammed into a program that wasn't *ever* designed to handle it.

So, let's do a post-mortem of the issues with OSL 1, so that we can focus on what to improve in OSL 2.

## When you script, you begin with...

![Death to OSL](/images/death-to-osl@0,5x.jpg)

^> [Vsauce - Should I Die?](https://www.youtube.com/watch?v=zRxI0DaQrag) | *An important decision in every file format's life*

Let's start with a few glossary terms. Not the most fun, I know I know. But considering at least some people reading this aren't intimately familiar with exactly how OSL works, it's important to explain.

First up is the obvious - What is a 'grammar'? Well it's kinda what it sounds like - a set of rules that determine "is this a valid sentence?". Except in this case, our sentence is an OSL Script[^sentence].

Now, why is this important? Well, the grammar for our format is what allows us to actually *do* anything - when parsed, it allows us to transform text into a set of rules, and then we interpret those rules to get our drills.

Wait, what are drills? Drills are a term coined in OSL for 'actions', essentially. They're a group of values that act with parameters.

So, where did OSL go wrong? ~~Well where do you start honestly...~~

The biggest issue with OSL 1 is that the grammar was ambiguous and ***highly*** context-dependent. What that means is that the path something could take, and even whether it should take a path at *all* was situational. 

Here's one quick example - Let's say we want to write a line of text to the screen.

```osl
OSL Script
Text|But that's Kaede's lie, isn't it?
```

This is a valid script[^technically-valid-script], but there's a problem, which is demonstrated as follows.

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="561px" viewBox="-0.5 -0.5 561 455" content="&lt;mxfile modified=&quot;2019-06-22T01:34:59.694Z&quot; host=&quot;www.draw.io&quot; agent=&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0&quot; etag=&quot;eXVGY1n4CXt2gS0q8DAV&quot; version=&quot;10.8.0&quot; type=&quot;browser&quot;&gt;&lt;diagram name=&quot;Page-1&quot; id=&quot;10a91c8b-09ff-31b1-d368-03940ed4cc9e&quot;&gt;7VrbdtsoFP0arz4lC6GrH+tLMu20M9O402keiYVtplh4SThx8vUFCSwhZDtxHF+ynDxEHI4Q2nvrcDik5Xani+sUzSZfWYxpC4J40XJ7LQgd4ADxR1oeC4sfhoVhnJJYOZWGAXnC+k5lnZMYZ4YjZ4xyMjONQ5YkeMgNG0pT9mC6jRg1nzpDY2wZBkNEbet/JOYTZXUAKDv+wGQ8UY+OfNVxh4a/ximbJ+p5LeiO8p+ie4r0WMo/m6CYPVRMbr/ldlPGeHE1XXQxldhq2Ir7rlb0Lued4oQ/54ZPn77O5p9v4ot59PTtW+ezv+jHF4GaG3/UeOBYwKOaLOUTNmYJov3S2snfGctRgWiVPl8YmwmjI4z/Y84fFddozpkwTfiUql68IPxn5fpWDnXpq1ZvoUbOG4+6kfD08We1UblLNsvb8pa+z0ZJAZexeTpU7xzAqO06UTQEIxS6AbzQQkTpGPM18PmFn8SsMrjC/xqzKRZzEQ4ppoiTe1NySCl3vPQr2RMXisAXkBkV494jOsdak3tiV1Na0nhbIXgTpSWLtwaJzZRWlPS27DqHYnfVjA1mAyrm3onJvbgcy8u/B1+Ez2CYkhnX3eJJFQ9LDg8TwvFghnKoHkSAN+EttSBbywAmGxTdYdpZhsAuoywVXQlLpIgynrJfWBtFZAT5z7JHR1o50ohQWvFUMVTYWcKv0JRQyfsPnMYoQcqstOdA1W56EKJknAjbUEgDp+u0co9TjhdrGVa9gV609Fqnmg+VhUOH+0llzQjAW2gisERxKxbSdV+8Ysf8xCt8byIVpfyjXHJrtisiZ90Duq3oKT7quHaHsFT8Ravi3RBYGgPQi+T1OhmtVM3GqKA0cwEuhW48QzcXjlu0nx051PD/MCKmUbqw0SgTIcxY9rWPen4Yepe+V/k1ZgKjmjSLoKjGqKlz+XJbCja0BPsXO+v1+PTqwLapV83cHuQaBeElDMtf15SrW5Nrsc7vQq7NGUB0yPx4H8nUszKoddnR5iwqPKok2U6lvuMFb4XdzlzKkE8Q/yBWUfAnwjHOryjBLdiV42bJB+lDxOteWcIwk6UNmdUbJCNOuMdspBFaaEELFgAKaEGBH1iDGdiMmRkrYT0j3QGkHjDDjecdGlL31CH1vWOD1GuC1DkhSIPo2CD1LUivEJF3DTji+NjxjLzD7eqalyhbok07Oy7XLXO/jjPyhO5yBwntTOZF+ez8TsvvyV2xSDYylUZWNskUj+RQEjMyRPSjMnOZsHQywQ1Jxt/z7EV8PjsScW31goGFutsAOnwz0O3tdMPu5KQxD2vZtB8dFnJoh9pzdl3Lmjem1yrpOpLsevl+Z0q3p9Q9KkpdezXq3dgnC1tFxnqNth4MpySOc4msqPRU68U2MWsVaoXN5RGjmnKrekzXFE7BZei0Q3MVUxFt20KJDtTGoFoPq6souyp3QP+QX+92x4Hm1+sc/us9rjNBraVzQH4Fpd5xUdo+U/rO0ib3nAm/nlKnfVScNhx3NRza926u0RQ/87g+nbDp3Tx7RtGkWiKxKygryXjB/t019++wofocNWwm6+eNu4O7bcENFl5wQnW9qAbp4et60K6J9GlmF/ROvCpSOxJvQwt2b59lEdc+ourd2PvqkwbdC2o1bOAfGHS7hv1v7/p9gR7Wz2IODrodX3647wvzqA02Yr6joqtolv9NXJQEyn/Zdvu/AQ==&lt;/diagram&gt;&lt;/mxfile&gt;" onclick="(function(svg){var src=window.event.target||window.event.srcElement;while (src!=null&amp;&amp;src.nodeName.toLowerCase()!='a'){src=src.parentNode;}if(src==null){if(svg.wnd!=null&amp;&amp;!svg.wnd.closed){svg.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&amp;&amp;evt.source==svg.wnd){svg.wnd.postMessage(decodeURIComponent(svg.getAttribute('content')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);svg.wnd=window.open('https://www.draw.io/?client=1&amp;lightbox=1&amp;edit=_blank');}}})(this);" style="cursor:pointer;max-width:100%;max-height:455px;"><defs/><g><path d="M 328 31 L 431.63 31" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 436.88 31 L 429.88 34.5 L 431.63 31 L 429.88 27.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 268 61 L 268 114.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 268 119.88 L 264.5 112.88 L 268 114.63 L 271.5 112.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="208" y="1" width="120" height="60" rx="9" ry="9" fill="#000000" stroke="#000000" transform="translate(2,3)" opacity="0.25"/><rect x="208" y="1" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(236.5,22.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="62" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Verdana; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 63px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><div>OSL Script</div></div></div></foreignObject><text x="31" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Verdana">&lt;div&gt;OSL Script&lt;/div&gt;</text></switch></g><path d="M 268 181 L 268 214.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 268 219.88 L 264.5 212.88 L 268 214.63 L 271.5 212.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="208" y="121" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(209.5,135.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="116" height="27" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 116px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">Text|But that's Kaede's lie, isn't it?</div></div></foreignObject><text x="58" y="20" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Text|But that's Kaede's lie, isn't it?</text></switch></g><rect x="1" y="391" width="120" height="60" fill="#000000" stroke="#000000" stroke-width="2" transform="translate(2,3)" opacity="0.25"/><rect x="1" y="391" width="120" height="60" fill="#ffffff" stroke="#000000" stroke-width="2" pointer-events="none"/><g transform="translate(37.5,412.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="46" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 47px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">0x02|0, 0</div></div></foreignObject><text x="23" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">0x02|0, 0</text></switch></g><rect x="141" y="391" width="120" height="60" fill="#000000" stroke="#000000" stroke-width="2" transform="translate(2,3)" opacity="0.25"/><rect x="141" y="391" width="120" height="60" fill="#ffffff" stroke="#000000" stroke-width="2" pointer-events="none"/><g transform="translate(177.5,412.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="46" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 47px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">0x02|0, 0</div></div></foreignObject><text x="23" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">0x02|0, 0</text></switch></g><rect x="281" y="391" width="120" height="60" fill="#000000" stroke="#000000" stroke-width="2" transform="translate(2,3)" opacity="0.25"/><rect x="281" y="391" width="120" height="60" fill="#ffffff" stroke="#000000" stroke-width="2" pointer-events="none"/><g transform="translate(317.5,412.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="46" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 47px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">0x01|0, 0</div></div></foreignObject><text x="23" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">0x01|0, 0</text></switch></g><rect x="438" y="1" width="120" height="60" fill="#000000" stroke="#000000" stroke-width="2" transform="translate(2,3)" opacity="0.25"/><rect x="438" y="1" width="120" height="60" fill="#ffffff" stroke="#000000" stroke-width="2" pointer-events="none"/><g transform="translate(472.5,22.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="49" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 50px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">Fail State</div></div></foreignObject><text x="25" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Fail State</text></switch></g><g transform="translate(279.5,77.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="19" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Yes</div></div></foreignObject><text x="10" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Yes</text></switch></g><g transform="translate(372.5,9.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="14" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">No</div></div></foreignObject><text x="7" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">No</text></switch></g><path d="M 268 301 L 268 346 L 61 346 L 61 384.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 61 389.88 L 57.5 382.88 L 61 384.63 L 64.5 382.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 268 301 L 268 346 L 201 346 L 201 384.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 201 389.88 L 197.5 382.88 L 201 384.63 L 204.5 382.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(206.5,358.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="24" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">DR2</div></div></foreignObject><text x="12" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">DR2</text></switch></g><path d="M 308 261 L 498 261 L 498 67.37" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 498 62.12 L 501.5 69.12 L 498 67.37 L 494.5 69.12 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 268 301 L 268 346 L 341 346 L 341 384.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 341 389.88 L 337.5 382.88 L 341 384.63 L 344.5 382.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 268 301 L 268 346 L 61 346 L 61 384.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 61 389.88 L 57.5 382.88 L 61 384.63 L 64.5 382.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 268 301 L 268 346 L 488 346 L 488 384.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 488 389.88 L 484.5 382.88 L 488 384.63 L 491.5 382.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 268 221 L 308 261 L 268 301 L 228 261 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" transform="translate(2,3)" opacity="0.25"/><path d="M 268 221 L 308 261 L 268 301 L 228 261 Z" fill="#ffffff" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(242.5,252.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="50" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 51px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;"><div>DRGame</div></div></div></foreignObject><text x="25" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">&lt;div&gt;DRGame&lt;/div&gt;</text></switch></g><rect x="428" y="391" width="120" height="60" fill="#000000" stroke="#000000" stroke-width="2" transform="translate(2,3)" opacity="0.25"/><rect x="428" y="391" width="120" height="60" fill="#ffffff" stroke="#000000" stroke-width="2" pointer-events="none"/><g transform="translate(464.5,412.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="46" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 47px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">0x46|0, 0</div></div></foreignObject><text x="23" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">0x46|0, 0</text></switch></g><g transform="translate(374.5,243.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="23" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Else</div></div></foreignObject><text x="12" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Else</text></switch></g><g transform="translate(62.5,356.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="24" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">DR1</div></div></foreignObject><text x="12" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">DR1</text></switch></g><g transform="translate(342.5,356.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="26" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">UDG</div></div></foreignObject><text x="13" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">UDG</text></switch></g><g transform="translate(489.5,356.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="14" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">V3</div></div></foreignObject><text x="7" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">V3</text></switch></g></g></svg>

Did you find the problem? I'll give you another few seconds to mull it over.

---

The problem with OSL 1 was that it handled whether something was a valid identifier *in the parsing stage*. Many blocks were checked and validated as they were happening.

What's the issue here? Well, apart from being overly complicated it was also a ***nightmare*** to work with things that needed to be resolved with other contextual information. Things like choices need the final label to jump/set respectively, but not all the details are known ahead of time. There's inherent coordination that needs to be done that is just... nasty to work with.

What this *also* meant was that a game had to be defined ahead of time, and *the grammar would not be parsed without it*. This meant that you couldn't even validate whether a script *might* be valid without defining a game, and it meant that a game-dependent script was always intrinsically tied to the current understanding of said game. Changes to the op code names were backwards **incompatible**, and would brick any scripts that used those op code names (like has happened several times).

This creates another few problems by the way. The startup process for OSL parsing looked something like this...

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="324px" viewBox="-0.5 -0.5 324 475" content="&lt;mxfile modified=&quot;2019-06-22T01:48:34.850Z&quot; host=&quot;www.draw.io&quot; agent=&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0&quot; etag=&quot;s-jQqLFX5kJ5ov1Xf8J2&quot; version=&quot;10.8.0&quot; type=&quot;browser&quot;&gt;&lt;diagram id=&quot;YNwr2Xqx4Fi1JlGUFDP3&quot; name=&quot;Page-1&quot;&gt;7VjbcpswEP0aHtsBZBL8WNu5zDS9TN2ZxI8KrEEpIEaIGPvruwJhwCQOnbGHtpMn0NGukM7qrFYYZB4XN4Km4RfuQ2TYpl8YZGHYtmVaJj4Usq0Q5/KyAgLBfG3UAEu2g9pToznzIesYSs4jydIu6PEkAU92MCoE33TN1jzqfjWlAfSApUejPnrPfBlWqOuYDX4LLAjrL1um7olpbayBLKQ+37QgcmWQueBcVm9xMYdIkVfzUvldv9K7n5iARA5xSFdTN0uKnby/mcbk6eFzYK8/ED03ua0XDD6uXze5kCEPeEKjqwadCZ4nPqhRTWw1NnecpwhaCD6BlFsdTJpLjlAo40j3QsHkg3L/6OjWqtWzKPTIZWNbNxIpti0n1Vy1+xq3slX7VetTi3qVNg1lPBceHOGq3n5UBCCP2Nn74KIqgMeA80E/ARGV7Lk7D6q3Z7C3ayKILzqIfxBQPe4zjXL9pW/LOwSWnmCp7EW7iaWifxMyCcuUljRsUNDduOmhQUgojrPZX712IBdaDToduLq5abRl1YIJW7qq3U7Ol/MugMECsAcKYDKmAOyeAL5TkQFCt0B9EEckYL4tgUwK/mt/EtgKqdP6mRRim2NLZDqmRKyWQBq5vCWRjkAavZxfIpOBEnFHPSPeT/3TR9Qa9dif9LLeAu0xaajE54U0CdQLTbYyZElgkOt+Ggx5/JhnA1JgO+H18+FJUqDTSYHEfiEFWi+kwD14eslYPcJGk4w5TDLWaEnQ/RcKZbenmB+Al0jc0DleI5uC2VwLHuOD5zLNjxXQQ6qHs0vHOageyMQZuXqoJdkieoUX+kMeccmyS5aAjO3oY2mguE05S2Q5O2dmOAtElGCySjvKgUYsSPA9grUaSvHI8CL/ScNSiW6WYXAwA/4sFYhp8ySsT6YHCcu56LFOXiDdPhvpr1fBb14E/4p9fFgFT6ZjV8FW/4j9yv+zbUzsLunEPdc2xmbz56vsa/0/JFe/AQ==&lt;/diagram&gt;&lt;/mxfile&gt;" onclick="(function(svg){var src=window.event.target||window.event.srcElement;while (src!=null&amp;&amp;src.nodeName.toLowerCase()!='a'){src=src.parentNode;}if(src==null){if(svg.wnd!=null&amp;&amp;!svg.wnd.closed){svg.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&amp;&amp;evt.source==svg.wnd){svg.wnd.postMessage(decodeURIComponent(svg.getAttribute('content')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);svg.wnd=window.open('https://www.draw.io/?client=1&amp;lightbox=1&amp;edit=_blank');}}})(this);" style="cursor:pointer;max-width:100%;max-height:475px;"><defs/><g><path d="M 61 60 L 61 113.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 61 118.88 L 57.5 111.88 L 61 113.63 L 64.5 111.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="1" y="0" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(31.5,21.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="58" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 59px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">OSL Script</div></div></foreignObject><text x="29" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">OSL Script</text></switch></g><path d="M 61 180 L 61 233.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 61 238.88 L 57.5 231.88 L 61 233.63 L 64.5 231.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="1" y="120" width="120" height="60" fill="#000000" stroke="#000000" stroke-width="2" transform="translate(2,3)" opacity="0.25"/><rect x="1" y="120" width="120" height="60" fill="#ffffff" stroke="#000000" stroke-width="2" pointer-events="none"/><g transform="translate(24.5,141.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="72" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 73px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">Parse Header</div></div></foreignObject><text x="36" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Parse Header</text></switch></g><path d="M 116 295 L 194.63 295" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 199.88 295 L 192.88 298.5 L 194.63 295 L 192.88 291.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 61 350 L 61 403.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 61 408.88 L 57.5 401.88 L 61 403.63 L 64.5 401.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 61 240 L 116 295 L 61 350 L 6 295 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" transform="translate(2,3)" opacity="0.25"/><path d="M 61 240 L 116 295 L 61 350 L 6 295 Z" fill="#ffffff" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(7.5,278.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="105" height="27" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 105px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">Did we change anything?</div></div></foreignObject><text x="53" y="20" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Did we change anything?</text></switch></g><path d="M 261 265 L 261 150 L 127.37 150" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 122.12 150 L 129.12 146.5 L 127.37 150 L 129.12 153.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="201" y="265" width="120" height="60" fill="#000000" stroke="#000000" stroke-width="2" transform="translate(2,3)" opacity="0.25"/><rect x="201" y="265" width="120" height="60" fill="#ffffff" stroke="#000000" stroke-width="2" pointer-events="none"/><g transform="translate(202.5,278.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="115" height="27" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 115px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">Reconstruct Script from output</div></div></foreignObject><text x="58" y="20" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Reconstruct Script from output</text></switch></g><g transform="translate(137.5,276.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="19" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Yes</div></div></foreignObject><text x="10" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Yes</text></switch></g><rect x="1" y="410" width="120" height="60" fill="#000000" stroke="#000000" stroke-width="2" transform="translate(2,3)" opacity="0.25"/><rect x="1" y="410" width="120" height="60" fill="#ffffff" stroke="#000000" stroke-width="2" pointer-events="none"/><g transform="translate(27.5,431.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="65" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 66px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">Parse Script</div></div></foreignObject><text x="33" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Parse Script</text></switch></g><g transform="translate(74.5,358.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="14" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">No</div></div></foreignObject><text x="7" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">No</text></switch></g></g></svg>

This was ***nasty***. The script had to be parsed several times over, and often would break if your formatting was slightly awkward. Header declarations embedded data into the script, which isn't awful as a preprocessing method but meant that we had to keep checking *just in case* something changed.

Formatted text worked a similar way - OSL supports[^localisation] localisation, but since localised strings might have formatting (or - horrifically - might require localisation themselves!) that means that we have to process our string again!

It's... worth noting here that the way OSL 1 did this kind of meta inclusions was messy. It created a pseudo- script file, then parsed the whole thing as if it were another OSL file... Yeah, not proud of that.

One small minor point here, is that because of how sensitive OSL lines are to context, you could never *really* do syntax highlighting. There's no IDE or graphical processor for OSL scripts, which means that your best bet *is* a text editor. The lack of highlighting means you're mostly operating in the dark, which isn't ideal.

## Looking Skyward

The future is not all dark, however. ANTLR offers a number of advantages over the systems we had to use with parboiled, and one of those is the separation of components; parsing is split into three different stages, which I'll explain next time. Who knows, maybe I'll even be able to talk about it in a way people understand!

OSL 2 offers to improve on almost every element of OSL 1 - better syntax, better processing, and if I have time I'll finally write some goddamn documentation and syntax highlighting.

---

Thanks for reading everyone, it's been a while since I've written anything on this so apologies if it's a little rusty.

I've taken a short break from the [other project](https://twitter.com/undermybrella/status/1141261925075968000) I had in the works, since I decided it was worthwhile to have another crack at something that's been bugging me for a while. 

That's right, these projects live and die on my whims.

Fortunately, I am a benevolent deity.

---

[^peggle-2]: I had to buy a book for this section, which cost ~$30; by comparison, most other elements have just been free, or minimal hosting costs.
[^kokichi]: Okay that's a lie, I do care actually, and I did what I could to cut down on the incompatibilities.
[^dr2-broke-me]: Special props to Ziella for taking away all faith I had in DR2, and also actually figuring out what a bunch of the op codes are.
[^define-feature-creep]: Feature creep (sometimes known as requirements creep or scope creep) is a tendency for product or project requirements to increase during development beyond those originally foreseen.
[^sentence]: *Sort of*. In actuality, you have each line or block as a sentence, but you get the idea.
[^technically-valid-script]: It's missing a lot of key elements, but it should compile and work if embedded in another script via the Run Script op code.
[^localisation]: The 'current' method isn't very good, but it does technically support it!